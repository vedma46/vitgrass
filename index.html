<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>–í–∏—Ç–≥—Ä–∞—Å—Å-—Ñ–µ—Ä–º–∞ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<style>
  :root{
    --bg:#092733; --bg2:#0e3341;
    --panel:#0b2b38; --panel2:#0f3240;
    --ink:#e6fbff; --ink2:#bfe9f3;
    --accent:#23d2ff; --green:#42e87a; --gold:#ffd46b; --pink:#ff6f9c;
    --outline:#001922; --shadow:rgba(0,0,0,.5);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(120% 100% at 50% 0%,var(--bg2),var(--bg));color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  #root{position:relative;height:100%;max-width:780px;margin:0 auto;display:flex;flex-direction:column;gap:6px}

  /* HUD TOP */
  .hud{display:flex;align-items:center;justify-content:space-between;padding:8px 10px 0}
  .avatar{display:flex;align-items:center;gap:10px}
  .ava{width:46px;height:46px;border-radius:10px;background:#fff1;box-shadow:0 3px 0 var(--outline) inset,0 6px 16px var(--shadow)}
  .lvl{display:flex;flex-direction:column;gap:4px;min-width:150px}
  .lvl b{font-weight:800;font-size:13px;letter-spacing:.2px}
  .bar{height:8px;background:#0a2530;border:2px solid #07303d;border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,#39f5ff,#2fe3ff 60%,#31caff);box-shadow:0 0 10px #31caff}

  .res{display:flex;gap:16px;align-items:center}
  .res .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:linear-gradient(#103846,#0f3340);border:2px solid #0a2430;box-shadow:0 3px 0 #00161d inset}
  .ico{font-weight:900;text-shadow:0 2px 0 #0004}
  .g{color:var(--green)} .c{color:var(--gold)} .j{color:#6fd1ff}

  /* GAME CANVAS */
  #gamewrap{position:relative;flex:1;min-height:420px;margin:4px 8px;border-radius:18px;
    box-shadow:inset 0 0 0 2px #0a2a36, 0 12px 24px var(--shadow);
    background:linear-gradient(180deg,#0b2d3a,#0b2630 60%,#0a202a)}
  #game{width:100%;height:100%;display:block}

  /* BOTTOM BAR */
  .nav{position:relative;display:flex;gap:14px;justify-content:space-between;padding:10px 14px 16px}
  .btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;height:58px;border-radius:16px;
    background:linear-gradient(#165063,#133c4a);border:3px solid #0a2c38;
    box-shadow:0 5px 0 #001922, 0 8px 20px var(--shadow);font-weight:800}
  .btn.big{height:62px;transform:translateY(-6px);background:linear-gradient(#1f7aa0,#15607a);border-color:#0a3a49}
  .btn:active{transform:translateY(1px)}
  .btn span{font-size:14px;letter-spacing:.2px}
  .bicon{width:22px;height:22px;display:inline-block}

  /* MODALS */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;padding:12px;z-index:20}
  .sheet{width:min(720px,96vw);max-height:82vh;overflow:auto;border-radius:18px;background:linear-gradient(#0d3240,#0a2a36);border:2px solid #0a2c38;box-shadow:0 14px 34px var(--shadow);padding:14px}
  .sheet h3{margin:4px 2px 10px;font-size:18px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0;padding:10px;border-radius:12px;background:#0b2a35;border:1px solid #0a3341}
  .row small{opacity:.85;color:var(--ink2)}
  .primary{background:linear-gradient(#23d2ff,#19aac9);border:0;color:#05313d;padding:10px 14px;border-radius:10px;font-weight:900}
  .ghost{background:#103847;border:1px solid #124352;color:#bcecff;padding:8px 12px;border-radius:10px;font-weight:800}
  .row .primary:disabled{opacity:.55}
  .closebar{display:flex;justify-content:center;margin-top:10px}
  .pill{padding:6px 10px;border-radius:12px;background:#134151;border:1px solid #0e3442}

  /* Toast */
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#00161d;color:#d8fbff;border:2px solid #0a3341;border-radius:999px;padding:8px 14px;opacity:0;transition:opacity .2s;pointer-events:none;z-index:40}

  @media (max-width:420px){ .btn span{display:none} }
</style>
</head>
<body>
<div id="root">
  <!-- HUD -->
  <div class="hud">
    <div class="avatar">
      <div class="ava"></div>
      <div class="lvl">
        <b>Farm Lv.<span id="lv">1</span></b>
        <div class="bar"><div id="xpFill" class="fill"></div></div>
        <small id="xpText" style="color:var(--ink2)">30 XP to next</small>
      </div>
    </div>
    <div class="res">
      <div class="chip"><span class="ico g">üåø</span><b id="rGrass">0</b></div>
      <div class="chip"><span class="ico j">ü•§</span><b id="rJuice">0</b></div>
      <div class="chip"><span class="ico c">ü™ô</span><b id="rCoins">30</b></div>
    </div>
  </div>

  <!-- GAME -->
  <div id="gamewrap"><canvas id="game"></canvas></div>

  <!-- NAV -->
  <div class="nav">
    <button id="navShop" class="btn"><span class="bicon">üõí</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
    <button id="navInv"  class="btn"><span class="bicon">üéí</span><span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button id="navMain" class="btn big"><span class="bicon">üíß</span><span>–ü–æ–ª–∏–≤</span></button>
    <button id="navUpg"  class="btn"><span class="bicon">‚ö°</span><span>–ê–ø–≥—Ä–µ–π–¥</span></button>
    <button id="navQ"    class="btn"><span class="bicon">üìú</span><span>–ö–≤–µ—Å—Ç—ã</span></button>
  </div>
</div>

<!-- SHEETS -->
<div id="sheetShop" class="modal"><div class="sheet">
  <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
  <div id="shopList"></div>
  <div class="closebar"><button class="ghost" data-close="sheetShop">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div id="sheetInv" class="modal"><div class="sheet">
  <h3>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
  <div id="invList"></div>
  <div class="pill" style="margin-top:8px">–†–µ–∂–∏–º —É–¥–æ–±—Ä–µ–Ω–∏—è: <b id="fertModeLabel">–≤—ã–∫–ª</b></div>
  <div class="closebar"><button class="ghost" data-close="sheetInv">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div id="sheetUpg" class="modal"><div class="sheet">
  <h3>‚ö° –ê–ø–≥—Ä–µ–π–¥—ã</h3>
  <div id="upgList"></div>
  <div class="closebar"><button class="ghost" data-close="sheetUpg">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div id="sheetQ" class="modal"><div class="sheet">
  <h3>üìú –ö–≤–µ—Å—Ç—ã</h3>
  <div id="qList"></div>
  <div class="closebar"><button class="ghost" data-close="sheetQ">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- CONTRACTS -->
<div id="sheetContract" class="modal"><div class="sheet">
  <h3>üì¶ –ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ —Å–æ–∫</h3>
  <div id="contractBody"></div>
  <div class="closebar">
    <button class="ghost" data-close="sheetContract">–ü–æ–∑–∂–µ</button>
  </div>
</div></div>

<div id="toast"></div>

<script>
/* =================== DATA =================== */
const SAVE_KEY="wg_mobile_v2";

const SEEDED=0, SPROUT=1, GROWTH=2, MATURE=3, OVERGROWN=4;
const STAGE_TIME=[8,14,22,30,Infinity];
const AUTOWATER_TICK=5, AUTOWATER_AMOUNT=.18;

const LAMP_COST = 150;         // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ–∫–∞—è —Ü–µ–Ω–∞ –∑–∞ –ª–∞–º–ø—É
const PER_LAMP = 0.20;         // ~20% –∑–∞ –ª–∞–º–ø—É —Å —É–±—ã–≤–∞—é—â–µ–π –æ—Ç–¥–∞—á–µ–π
const FERT_PRICE = 28;         // —É–¥–æ–±—Ä–µ–Ω–∏–µ –¥–æ—Ä–æ–≥–æ–µ
const FERT_DURATION = 120;     // —Å–µ–∫
let FERT_MODE = false;         // –∫–ª–∏–∫ –ø–æ —Ä–∞—Å—Ç–µ–Ω–∏—é –ø—Ä–∏–º–µ–Ω—è–µ—Ç —É–¥–æ–±—Ä–µ–Ω–∏–µ

const SEEDS=[
  {id:'basic',   name:'–û–±—ã—á–Ω—ã–µ',   pack:5, price:12, speed:1.00, ym:2, yo:1, unlock:1, color:[84,210,110]},
  {id:'fast',    name:'–°–∫–æ—Ä–æ—Å–ø–µ–ª—ã–µ',pack:5, price:16, speed:1.35, ym:1, yo:1, unlock:2, color:[96,230,150]},
  {id:'juicy',   name:'–°–æ—á–Ω—ã–µ',    pack:5, price:20, speed:0.95, ym:3, yo:1, unlock:4, color:[74,205,118]},
  {id:'premium', name:'–ü—Ä–µ–º–∏—É–º',   pack:3, price:26, speed:0.85, ym:4, yo:2, unlock:6, color:[68,190,110]},
];

function defaultState(){
  const stock=Object.fromEntries(SEEDS.map(s=>[s.id,0])); stock.basic=6;
  return {
    level:1, xp:0, coins:30, grass:0, juice:0,
    seeds:stock, selSeed:'basic',
    autowater:false, fert:0,
    lampStock:0,                 // –∫—É–ø–ª–µ–Ω–Ω—ã–µ, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ª–∞–º–ø—ã
    stats:{plants:0, waters:0, harvests:0, sell:0, play:0},
    pots:Array.from({length:12},()=>({has:false,seed:0,stage:SEEDED, t:0, moist:0, fert:0, flash:0, lamps:0})),
    contract:null,               // {need, price, ttl}
    nextContract: 90             // —Ç–∞–π–º–µ—Ä –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (—Å–µ–∫)
  };
}
let S = load() || defaultState();

/* =================== CANVAS =================== */
const wrap=document.getElementById('gamewrap'), cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
let DPR=1, L={w:0,h:0, cols:3, rows:4, pw:120, ph:100, gx:16, gy:18, ox:0, oy:0};
const potsRect = Array.from({length:12},()=>({x:0,y:0,w:0,h:0}));

function resize(){
  DPR = window.devicePixelRatio||1;
  const r=wrap.getBoundingClientRect();
  cvs.width=r.width*DPR; cvs.height=r.height*DPR; cvs.style.width=r.width+"px"; cvs.style.height=r.height+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
  L.w=r.width; L.h=r.height;

  L.cols=3; L.rows=4;
  L.pw = Math.floor((L.w-32 - 24)/3);
  L.ph = Math.floor((L.h-48 - 36)/4);
  L.gx=12; L.gy=10; L.ox=16; L.oy=16;

  for(let i=0;i<12;i++){
    const r=Math.floor(i/3), c=i%3;
    potsRect[i]={x:L.ox + c*(L.pw+L.gx), y:L.oy + r*(L.ph+L.gy), w:L.pw, h:L.ph};
  }
}
window.addEventListener('resize', resize);

/* =================== DRAW =================== */
function rr(x,y,w,h,r){ const a=Math.min(r,w/2,h/2); ctx.beginPath();
  ctx.moveTo(x+a,y); ctx.arcTo(x+w,y,x+w,y+h,a); ctx.arcTo(x+w,y+h,x,y+h,a);
  ctx.arcTo(x,y+h,x,y,a); ctx.arcTo(x,y,x+w,y,a); ctx.closePath(); }
function rgb(a){ return `rgb(${a[0]},${a[1]},${a[2]})`; }
function tint(c,k){ return [c[0]*k|0,c[1]*k|0,c[2]*k|0]; }

function drawShelves(){
  // —Å—Ç–æ–π–∫–∏
  ctx.fillStyle="#0f657d"; rr(L.ox-14,L.oy-10,10,L.h-(L.oy-10)*2,10); ctx.fill();
  rr(L.w-L.ox+4,L.oy-10,10,L.h-(L.oy-10)*2,10); ctx.fill();

  for(let r=0;r<4;r++){
    const y=potsRect[r*3].y + L.ph + 8;
    ctx.fillStyle="#0b5570"; rr(L.ox-8,y,L.w-L.ox*2+16,10,6); ctx.fill();
    ctx.fillStyle="#1aa3c9"; rr(L.ox-6,y-4,L.w-L.ox*2+12,10,6); ctx.fill();
  }
}

function drawLampBars(R,count){
  if(count<=0) return;
  const w=18, h=6, gap=8;
  const total = count*w + (count-1)*gap;
  let x = R.x + (R.w-total)/2;
  const y = R.y - 6; // –Ω–∞–¥ –ø–æ–¥–¥–æ–Ω–æ–º
  for(let i=0;i<count;i++){
    rr(x,y,w,h,4); ctx.fillStyle="#ff917a"; ctx.fill();
    ctx.shadowColor="#ff6f6f"; ctx.shadowBlur=10; ctx.fillStyle="rgba(255,160,130,.35)";
    rr(x-2,y-4,w+4,h+8,6); ctx.fill(); ctx.shadowBlur=0;
    x += w+gap;
  }
}

function drawPot(i){
  const P=S.pots[i], R=potsRect[i];

  // –ª–∞–º–ø—ã (–Ω–∞–¥ –ø–æ–¥–¥–æ–Ω–æ–º)
  drawLampBars(R, P.lamps);

  // –ø–æ–¥–¥–æ–Ω
  ctx.save();
  rr(R.x, R.y+8, R.w, R.h-8, 16); ctx.fillStyle="#0c4052"; ctx.fill();
  rr(R.x+8, R.y+20, R.w-16, R.h-30, 14); ctx.fillStyle="#0a2631"; ctx.fill();

  // –≤–ª–∞–∂–Ω–æ—Å—Ç—å
  const mw = Math.max(4, Math.floor((R.w-24) * (P.moist||0)));
  rr(R.x+12, R.y+R.h-22, mw, 10, 6); ctx.fillStyle="#2dd1ff"; ctx.fill();

  // —Ä–∞—Å—Ç–µ–Ω–∏—è
  if(P.has){
    const seed=SEEDS[P.seed], base=[...seed.color];
    let blades=6, h=Math.floor(R.h*0.45);
    if(P.stage===SEEDED){ blades=2; h=R.h*0.18; }
    else if(P.stage===SPROUT){ blades=4; h=R.h*0.30; }
    else if(P.stage===GROWTH){ blades=7; h=R.h*0.42; }
    else if(P.stage===MATURE){ blades=9; h=R.h*0.50; }
    else if(P.stage===OVERGROWN){ blades=9; h=R.h*0.46; base=tint(base,.75); }

    ctx.lineWidth=2; ctx.strokeStyle=rgb(base);
    const baseY=R.y+R.h-28, step=Math.max(4,Math.floor(R.w/(blades+3)));
    for(let k=0;k<blades;k++){
      const x=R.x+18+k*step;
      const wob=Math.sin((performance.now()/300)+(i*2)+k)*2;
      ctx.beginPath(); ctx.moveTo(x,baseY); ctx.lineTo(x, baseY - h + ((k%3)*-3) + wob); ctx.stroke();
    }

    // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑—Ä–µ–ª–æ—Å—Ç–∏
    if(P.stage===MATURE || P.stage===OVERGROWN){
      ctx.fillStyle = P.stage===MATURE ? "#38e27b" : "#ffb35e";
      ctx.beginPath(); ctx.arc(R.x+R.w-14, R.y+18, 8, 0, Math.PI*2); ctx.fill();
    }
  }

  if(P.flash>0){ ctx.globalAlpha=Math.min(.6,P.flash/.18); ctx.fillStyle="#fff"; rr(R.x,R.y,R.w,R.h,16); ctx.fill(); ctx.globalAlpha=1; }
  ctx.restore();
}

function draw(){
  const g=ctx.createLinearGradient(0,0,0,L.h); g.addColorStop(0,"#0f3441"); g.addColorStop(1,"#0a2631");
  ctx.fillStyle=g; ctx.fillRect(0,0,L.w,L.h);

  drawShelves();
  for(let i=0;i<12;i++) drawPot(i);
}

/* =================== GAME LOGIC =================== */
function levelReq(l){ return 30+(l-1)*20; }
function addXP(v){
  S.xp+=v; let up=0;
  while(S.xp>=levelReq(S.level)){ S.xp-=levelReq(S.level); S.level++; up++; }
  if(up>0) toast(`–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${S.level}!`);
  syncHUD();
}

function perLampBonus(n){ return 1 - Math.pow(1-PER_LAMP, Math.min(3,n|0)); }
function potSpeed(P){
  const base = SEEDS[P.seed].speed;
  const moist = 1 + P.moist*0.8;
  const fert = P.fert>0 ? 1.35 : 1;
  const lamp = 1 + perLampBonus(P.lamps);
  return base * moist * fert * lamp;
}

/* ===== Contracts (orders for juice) ===== */
function maybeSpawnContract(dt){
  if(S.contract){ S.contract.ttl -= dt; if(S.contract.ttl<=0){ S.contract=null; toast('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏—Å—Ç—ë–∫'); } return; }
  S.nextContract -= dt;
  if(S.nextContract<=0){
    // –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
    const need = 4 + Math.floor(Math.random()*5); // 4..8
    const price = 8 + Math.floor(Math.random()*3); // 8..10 –∑–∞ —Å—Ç–∞–∫–∞–Ω
    S.contract = {need, price, ttl: 45};          // –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 45 —Å–µ–∫
    S.nextContract = 80 + Math.random()*40;       // 80..120 —Å–µ–∫ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ
    showContract();
  }
}
function showContract(){
  const body=document.getElementById('contractBody');
  const c=S.contract; if(!c){ close('sheetContract'); return; }
  body.innerHTML = `
    <div class="row">
      <div><b>–ù—É–∂–Ω–æ: ${c.need} —Å—Ç–∞–∫–∞–Ω–æ–≤</b><br><small>–û–ø–ª–∞—Ç–∞: ${c.price} –º–æ–Ω. –∑–∞ –∫–∞–∂–¥—ã–π</small></div>
      <button id="btnAccept" class="primary">–û—Ç–¥–∞—Ç—å</button>
    </div>
    <div class="pill">–í –Ω–∞–ª–∏—á–∏–∏: ${S.juice} ‚Ä¢ –í—Ä–µ–º—è: <b id="ttl"></b></div>
  `;
  document.getElementById('btnAccept').disabled = S.juice < c.need;
  document.getElementById('btnAccept').onclick = ()=>{
    if(S.juice < c.need) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–æ–∫–∞'); return; }
    S.juice -= c.need; S.coins += c.need*c.price; S.contract=null; syncHUD(); save(); close('sheetContract'); toast('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω!');
  };
  open('sheetContract');
}
function updateContractTtlUI(){
  if(!S.contract) return;
  const el=document.getElementById('ttl'); if(el) el.textContent = Math.max(0, S.contract.ttl|0)+'s';
}

/* =================== LOOP =================== */
let last=performance.now(), awAcc=0;
function step(now){
  const dt=Math.min(.1,(now-last)/1000); last=now;
  S.stats.play += dt;

  if(S.autowater){ awAcc+=dt; if(awAcc>=AUTOWATER_TICK){ awAcc=0; S.pots.forEach(P=>{ if(P.has) P.moist=Math.min(1,P.moist+AUTOWATER_AMOUNT); }); } }

  for(const P of S.pots){
    P.moist=Math.max(0,P.moist - dt*0.02);
    if(P.fert>0) P.fert=Math.max(0,P.fert-dt);
    if(P.flash>0) P.flash=Math.max(0,P.flash-dt);
    if(!P.has) continue;
    P.t += dt*potSpeed(P);
    const target = STAGE_TIME[P.stage];
    if(P.stage<=GROWTH){ if(P.t>=target){ P.stage++; P.t=0; } }
    else if(P.stage===MATURE && P.t>=target){ P.stage=OVERGROWN; P.t=0; }
  }

  maybeSpawnContract(dt);
  updateContractTtlUI();

  draw();
  requestAnimationFrame(step);
}

/* =================== INPUT =================== */
cvs.addEventListener('pointerdown',(e)=>{
  const r=cvs.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  for(let i=0;i<12;i++){
    const R=potsRect[i]; if(x<R.x||x>R.x+R.w||y<R.y||y>R.y+R.h) continue;
    const P=S.pots[i];

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∞–º–ø—ã, –µ—Å–ª–∏ –≤ –∞–ø–≥—Ä–µ–π–¥–∞—Ö –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    if(placeLampMode){
      if(S.lampStock<=0){ toast('–ù–µ—Ç –ª–∞–º–ø –Ω–∞ —Å–∫–ª–∞–¥–µ'); break; }
      if(P.lamps>=3){ toast('–ú–∞–∫—Å–∏–º—É–º 3 –ª–∞–º–ø—ã'); break; }
      P.lamps++; S.lampStock--; toast('–õ–∞–º–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'); save(); draw(); syncHUD(); break;
    }

    // Fertilizer Mode
    if(FERT_MODE && P.has){
      if(S.fert<=0){ toast('–ù–µ—Ç —É–¥–æ–±—Ä–µ–Ω–∏–π'); break; }
      P.fert += FERT_DURATION; S.fert--; toast('–£–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ (+35% –Ω–∞ 120—Å)'); syncHUD(); save(); break;
    }

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    if(!P.has){
      const st=S.seeds[S.selSeed]; if((st|0)===0){ toast("–ù–µ—Ç —Å–µ–º—è–Ω –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞"); break; }
      const idx=SEEDS.findIndex(s=>s.id===S.selSeed);
      P.has=true; P.seed=idx; P.stage=SEEDED; P.t=0; P.moist=.4; P.fert=0; P.flash=0;
      S.seeds[S.selSeed]--; S.stats.plants++; addXP(2);
    }else if(P.stage===MATURE||P.stage===OVERGROWN){
      const T=SEEDS[P.seed]; const add = (P.stage===MATURE?T.ym:T.yo)|0;
      P.has=false; P.stage=SEEDED; P.t=0; P.moist=0; P.fert=0; P.flash=.18;
      S.grass+=add; S.stats.harvests++; addXP(4);
    }else{
      P.moist=Math.min(1,P.moist+.6); S.stats.waters++; addXP(1);
    }
    syncHUD(); save(); break;
  }
});

/* =================== UI / SHEETS =================== */
function open(id){ document.getElementById(id).style.display='flex'; }
function close(id){ document.getElementById(id).style.display='none'; }
document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>close(b.dataset.close));
document.getElementById('navShop').onclick = ()=>{ buildShop(); open('sheetShop'); };
document.getElementById('navInv').onclick  = ()=>{ buildInv();  open('sheetInv');  };
document.getElementById('navUpg').onclick  = ()=>{ buildUpg();  open('sheetUpg');  };
document.getElementById('navQ').onclick    = ()=>{ buildQuests();open('sheetQ');   };
document.getElementById('navMain').onclick = ()=> toast('–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ç–∞–ø–Ω–∏ –ø–æ –≥–æ—Ä—à–∫—É ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ');

function syncHUD(){
  document.getElementById('lv').textContent=S.level;
  const need=levelReq(S.level); const p=Math.min(99,(S.xp/need)*100);
  document.getElementById('xpFill').style.width=p+'%';
  document.getElementById('xpText').textContent=(need-S.xp|0)+' XP to next';
  document.getElementById('rGrass').textContent=S.grass;
  document.getElementById('rJuice').textContent=S.juice;
  document.getElementById('rCoins').textContent=S.coins;
  const lab=document.getElementById('fertModeLabel'); if(lab) lab.textContent = FERT_MODE?'–≤–∫–ª':'–≤—ã–∫–ª';
}

/* ---- Shop ---- */
function buildShop(){
  const box=document.getElementById('shopList'); box.innerHTML='';

  // —Å–µ–º–µ–Ω–∞
  SEEDS.forEach(s=>{
    const locked = S.level < s.unlock;
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `<div><b>–°–µ–º–µ–Ω–∞: ${s.name}</b><br><small>+${s.pack} —à—Ç. ‚Ä¢ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∞ —É—Ä. ${s.unlock}</small></div>`;
    const btn = document.createElement('button'); btn.className='primary';
    btn.textContent = locked ? 'üîí' : `${s.price} ü™ô`;
    btn.disabled = locked || S.coins < s.price;
    btn.onclick=()=>{ if(S.coins<s.price) return; S.coins-=s.price; S.seeds[s.id]=(S.seeds[s.id]||0)+s.pack; syncHUD(); save(); buildInv(); buildShop(); toast('–ö—É–ø–ª–µ–Ω—ã —Å–µ–º–µ–Ω–∞'); };
    row.appendChild(btn); box.appendChild(row);
  });

  // —É–¥–æ–±—Ä–µ–Ω–∏–µ (–¥–æ—Ä–æ–≥–æ–µ)
  const rowF=document.createElement('div'); rowF.className='row';
  rowF.innerHTML=`<div><b>–ö—É–ø–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ</b><br><small>+1 —à—Ç. ‚Ä¢ +35% —Ä–æ—Å—Ç–∞ –Ω–∞ 120—Å (–≤ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–µ –≤–∫–ª—é—á–∏ —Ä–µ–∂–∏–º)</small></div>`;
  const bF=document.createElement('button'); bF.className='primary'; bF.textContent=`${FERT_PRICE} ü™ô`;
  bF.disabled = S.coins < FERT_PRICE;
  bF.onclick=()=>{ if(S.coins<FERT_PRICE) return; S.coins-=FERT_PRICE; S.fert++; syncHUD(); save(); buildShop(); toast('+1 —É–¥–æ–±—Ä–µ–Ω–∏–µ'); };
  rowF.appendChild(bF); box.appendChild(rowF);

  // –°–æ–∫
  const rowJ=document.createElement('div'); rowJ.className='row';
  rowJ.innerHTML=`<div><b>–°–¥–µ–ª–∞—Ç—å —Å–æ–∫</b><br><small>‚àí1 —Ç—Ä–∞–≤–∞ ‚Üí +1 —Å—Ç–∞–∫–∞–Ω</small></div>`;
  const bJ=document.createElement('button'); bJ.className='primary'; bJ.textContent='–°–¥–µ–ª–∞—Ç—å';
  bJ.disabled = S.grass<1; bJ.onclick=()=>{ if(S.grass<1) return; S.grass--; S.juice++; syncHUD(); save(); buildShop(); toast('+1 —Å—Ç–∞–∫–∞–Ω —Å–æ–∫–∞'); };
  rowJ.appendChild(bJ); box.appendChild(rowJ);

  const rowSell=document.createElement('div'); rowSell.className='row';
  rowSell.innerHTML=`<div><b>–ü—Ä–æ–¥–∞—Ç—å —Å–æ–∫</b><br><small>+6 –º–æ–Ω–µ—Ç –∑–∞ —Å—Ç–∞–∫–∞–Ω</small></div>`;
  const bS=document.createElement('button'); bS.className='primary'; bS.textContent='+6 ü™ô';
  bS.disabled = S.juice<1; bS.onclick=()=>{ if(S.juice<1) return; S.juice--; S.coins+=6; S.stats.sell++; addXP(2); syncHUD(); save(); buildShop(); toast('+6 –º–æ–Ω–µ—Ç'); };
  rowSell.appendChild(bS); box.appendChild(rowSell);

  // –ö–æ–Ω—Ç—Ä–∞–∫—Ç
  const rowC=document.createElement('div'); rowC.className='row';
  const c=S.contract;
  if(c){
    rowC.innerHTML=`<div><b>–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç</b><br><small>–ù—É–∂–Ω–æ ${c.need}, –æ–ø–ª–∞—Ç–∞ ${c.price}/—à—Ç, –æ—Å—Ç–∞–ª–æ—Å—å <span id="ttl2">${c.ttl|0}s</span></small></div>`;
    const bC=document.createElement('button'); bC.className='primary'; bC.textContent='–û—Ç–∫—Ä—ã—Ç—å';
    bC.onclick=()=>showContract(); rowC.appendChild(bC);
  }else{
    rowC.innerHTML=`<div><b>–ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–µ—Ç</b><br><small>–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${S.nextContract|0}s</small></div>`;
    const bC=document.createElement('button'); bC.className='primary'; bC.textContent='OK'; bC.disabled=true; rowC.appendChild(bC);
  }
  box.appendChild(rowC);
}

/* ---- Inventory ---- */
function buildInv(){
  const box=document.getElementById('invList'); box.innerHTML='';
  SEEDS.forEach(s=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<div><b>${s.name}</b><br><small>${S.seeds[s.id]||0} —à—Ç.</small></div>`;
    const a=document.createElement('button'); a.className='ghost'; a.textContent = (S.selSeed===s.id?'–í—ã–±—Ä–∞–Ω–æ':'–í—ã–±—Ä–∞—Ç—å');
    a.onclick=()=>{ S.selSeed=s.id; syncHUD(); buildInv(); };
    row.appendChild(a); box.appendChild(row);
  });

  const rF=document.createElement('div'); rF.className='row';
  rF.innerHTML=`<div><b>–£–¥–æ–±—Ä–µ–Ω–∏–µ</b><br><small>${S.fert} —à—Ç. ‚Ä¢ –≤–∫–ª/–≤—ã–∫–ª —Ä–µ–∂–∏–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</small></div>`;
  const bT=document.createElement('button'); bT.className='primary'; bT.textContent= FERT_MODE?'–í—ã–∫–ª—é—á–∏—Ç—å':'–í–∫–ª—é—á–∏—Ç—å';
  bT.onclick=()=>{ FERT_MODE=!FERT_MODE; syncHUD(); buildInv(); toast('–†–µ–∂–∏–º —É–¥–æ–±—Ä–µ–Ω–∏—è: '+(FERT_MODE?'–≤–∫–ª':'–≤—ã–∫–ª')); };
  rF.appendChild(bT); box.appendChild(rF);
}

/* ---- Upgrades (–ª–∞–º–ø—ã –∏ –∞–≤—Ç–æ–ø–æ–ª–∏–≤) ---- */
let placeLampMode=false;
function buildUpg(){
  const box=document.getElementById('upgList'); box.innerHTML='';

  // –∫—É–ø–∏—Ç—å –ª–∞–º–ø—É (—Ñ–∏–∫—Å. —Ü–µ–Ω–∞)
  const rowL=document.createElement('div'); rowL.className='row';
  rowL.innerHTML=`<div><b>–ö—É–ø–∏—Ç—å –ª–∞–º–ø—É</b><br><small>–¶–µ–Ω–∞ ${LAMP_COST} ‚Ä¢ –ù–∞ —Å–∫–ª–∞–¥–µ: ${S.lampStock}</small></div>`;
  const bL=document.createElement('button'); bL.className='primary'; bL.textContent=`${LAMP_COST} ü™ô`;
  bL.disabled = S.coins<LAMP_COST;
  bL.onclick=()=>{ if(S.coins<LAMP_COST) return; S.coins-=LAMP_COST; S.lampStock++; syncHUD(); save(); buildUpg(); toast('–õ–∞–º–ø–∞ –∫—É–ø–ª–µ–Ω–∞'); };
  rowL.appendChild(bL); box.appendChild(rowL);

  // —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∞–º–ø
  const rowSet=document.createElement('div'); rowSet.className='row';
  rowSet.innerHTML=`<div><b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∞–º–ø—ã</b><br><small>–¢–∞–ø–Ω–∏ –ø–æ –≥–æ—Ä—à–∫—É, –º–∞–∫—Å 3 –Ω–∞ –≥–æ—Ä—à–æ–∫</small></div>`;
  const bSet=document.createElement('button'); bSet.className='primary'; bSet.textContent= placeLampMode?'–í—ã–∫–ª':'–í–∫–ª';
  bSet.onclick=()=>{ placeLampMode=!placeLampMode; toast('–†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∞–º–ø: '+(placeLampMode?'–≤–∫–ª':'–≤—ã–∫–ª')); };
  rowSet.appendChild(bSet); box.appendChild(rowSet);

  // –∞–≤—Ç–æ–ø–æ–ª–∏–≤
  const rowA=document.createElement('div'); rowA.className='row';
  rowA.innerHTML=`<div><b>–ê–≤—Ç–æ–ø–æ–ª–∏–≤</b><br><small>${S.autowater?'–ê–∫—Ç–∏–≤–µ–Ω (–∫–∞–∂–¥—ã–µ 5—Å +18% –≤–ª–∞–≥–∏)':'–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞'}</small></div>`;
  const bA=document.createElement('button'); bA.className='primary'; bA.textContent = S.autowater?'‚úì':'120 ü™ô';
  bA.disabled = S.autowater || S.coins<120;
  bA.onclick=()=>{ if(S.coins<120||S.autowater) return; S.coins-=120; S.autowater=true; syncHUD(); save(); buildUpg(); toast('–ê–≤—Ç–æ–ø–æ–ª–∏–≤ –≤–∫–ª—é—á—ë–Ω'); };
  rowA.appendChild(bA); box.appendChild(rowA);
}

/* ---- Quests (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª) ---- */
const DAILY=[
  {id:'plant',  name:'–ü–æ—Å–∞–¥–∏ 12 —Å–µ–º—è–Ω', key:'plants', need:12, reward:24},
  {id:'water',  name:'–ü–æ–ª–µ–π 16 —Ä–∞–∑',   key:'waters', need:16, reward:22},
  {id:'harv',   name:'–°–æ–±–µ—Ä–∏ 10 —É—Ä–æ–∂–∞–µ–≤', key:'harvests', need:10, reward:40},
  {id:'sell',   name:'–ü—Ä–æ–¥–∞–π 6 —Å—Ç–∞–∫–∞–Ω–æ–≤', key:'sell', need:6, reward:36},
];
function progressOf(k){ const v = S.stats[k]||0; const q=DAILY.find(x=>x.key===k); return {v, need:q.need, reward:q.reward, done:v>=q.need}; }
function buildQuests(){
  const box=document.getElementById('qList'); box.innerHTML='';
  DAILY.forEach(q=>{
    const st=progressOf(q.key);
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<div><b>${q.name}</b><br><small>${Math.min(st.v,q.need)}/${q.need} ‚Ä¢ –Ω–∞–≥—Ä–∞–¥–∞ +${q.reward}ü™ô</small></div>`;
    const b=document.createElement('button'); b.className='primary'; b.textContent= st.done? '–ó–∞–±—Ä–∞—Ç—å' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
    b.disabled=!st.done;
    b.onclick=()=>{ if(!st.done) return; S.coins+=q.reward; const left=(S.stats[q.key]-q.need); S.stats[q.key]=Math.max(0,left); syncHUD(); save(); buildQuests(); toast('–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞'); };
    row.appendChild(b); box.appendChild(row);
  });
}

/* =================== SAVE =================== */
function save(){ try{ localStorage.setItem(SAVE_KEY,JSON.stringify(S)); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem(SAVE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; } }

/* =================== UX =================== */
const toastBox=document.getElementById('toast');
function toast(t){ toastBox.textContent=t; toastBox.style.opacity=1; clearTimeout(toastBox._t); toastBox._t=setTimeout(()=>toastBox.style.opacity=0,1600); }

/* =================== INIT =================== */
resize(); syncHUD(); draw(); requestAnimationFrame(step);
</script>
</body>
</html>
